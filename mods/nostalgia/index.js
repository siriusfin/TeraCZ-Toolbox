const os = require('os');

module.exports = function Nostalgia(dispatch) {
    const DUNGEONS = {
        ABHM:   	[9711,-99937.953125,173327.75,710.5784301757812],

        A_BAS:      [9121,-115551.5546875,-182174.15625,334.4082946777344],
        A_FANG:     [9121,-129544.0625,-178823.96875,1147.7261962890625],

        BRHM:   	[9054,-82022.359375,139380.203125,874.4833984375],
        BRHM3:      [9054,-83728.2265625,166032.28125,1006.63916015625],

        TSHM:   	[9056,-130430.609375,97599.2734375,3377.879638671875],
        TSHM_MOBS:  [9056,-130667.4375,111537.3046875,28048.044921875],
        TSHM2:      [9056,-134914.03125,117819.484375,28726.548828125],
        TSHM3:      [9056,-131299.828125,130313.3125,29004.728515625],

        FIHM:   	[9759,-118816.0390625,34030.9765625,1670.25],
        REHM:   	[9050,-41541.5859375,171267.0625,-220.98403930664062],
        VHHM:  		[9980,59455.125,-133015.78125,2439.8076171875],
        VSHM:   	[9981,43945.921875,-134694.9375,29069.904296875],

        AIHM:   	[9057,-89011.4140625,100069.9296875,4850.33544921875],
        AIHM1:      [9057,-84000.5078125,94670.5703125,3727.20458984375],
        AIHM2:      [9057,-77901.9453125,98907.875,5749.259765625],
        AIHM3:      [9057,-82355.7421875,104376.6015625,4216.1005859375],
        AIHM4:      [9057,-85066.6640625,99665.5,3389.2734375],

        WHHM:   	[9043,30215.927734375,-49654.89453125,-527.4828491210938],
		MCHM:		[9027,-3585.83984375,95633.96875,-10964.48828125],
		LKHM:		[9969,-99682.3359375,33678.05859375,6481.25],
		RMHM:		[9970,-99676.6015625,3371.67529296875,6474.9755859375],
		KDHM:		[9060,-132798.78125,54445.91015625,3262.62646484375],
		SCHM:		[9916,57340.52734375,132190.03125,1968.2823486328125],

        ABNM:   	[9511,-99937.953125,173327.75,710.5784301757812],

        BRNM:   	[9754,-82022.359375,139380.203125,874.4833984375],
        BRNM3:      [9754,-83728.2265625,166032.28125,1006.63916015625],

        TSNM:   	[9756,-130430.609375,97599.2734375,3377.879638671875],
        TSNM_MOBS:  [9756,-129020.3203125,113302.5625,27283.041015625],
        TSNM2:      [9756,-134883.59375,117806.6640625,28726.548828125],
        TSNM3:      [9756,-131351.203125,130193.21875,29004.728515625],

        FINM:   	[9059,-118816.0390625,34030.9765625,1670.25],
        RENM:   	[9750,-41541.5859375,171267.0625,-220.98403930664062],
        VHNM:  		[9780,59455.125,-133015.78125,2439.8076171875],
        VSNM:   	[9781,43945.921875,-134694.9375,29069.904296875],
        
        AINM:  		[9757,-89011.4140625,100069.9296875,4850.33544921875],
        AINM1:      [9757,-84000.5078125,94670.5703125,3727.20458984375],
        AINM2:      [9757,-77901.9453125,98907.875,5749.259765625],
        AINM3:      [9757,-82355.7421875,104376.6015625,4216.1005859375],
        AINM4:      [9757,-85066.6640625,99665.5,3389.2734375],

        WHNM:   	[9743,30215.927734375,-49654.89453125,-527.4828491210938],
		LKNM:		[9769,-99682.3359375,33678.05859375,6481.25],
		RMNM:		[9770,-99676.6015625,3371.67529296875,6474.9755859375],
		KDNM:		[9760,-132798.78125,54445.91015625,3262.62646484375],
		SCNM:		[9716,57340.52734375,132190.03125,1968.2823486328125],

        RG:     	[9055,-120281.03125,176836.78125,1890.7274169921875],
        SF:     	[9766,-70335,-56779.640625,52.63845443725586],
        CW:    	 	[9777,-121615.8984375,-41477.68359375,2301.331298828125],
		LP:			[9810,-84587.9296875,171201.9375,13463.05859375],
		BP:			[9710,-82981.1015625,38585.61328125,13541.1513671875],
		MM:			[9070,-131714.234375,-52324.2421875,5511.4296875],

        KG:     	[9053,-45324.484375,87985.890625,1956.75],

        V1:         [9124, -130621.5390625, -117436.375, -85.75994873046875],
        V2:         [9125, -130621.5390625, -117436.375, -85.75994873046875],
        V3:         [9126, -130621.5390625, -117436.375, -85.75994873046875],
        VA:         [9127, -130621.5390625, -117436.375, -85.75994873046875],

        ECHO:   	[9069,-32615.8359375,-71702.1875,8508.201171875],
        GG:     	[9713,52250.1953125,115971.5,4347.85205078125],
        GG_OLD:		[9813,52250.1953125,115971.5,4347.85205078125],
		TOT:  		[9082,38039.57421875,-146411.359375,-306.0141906738281],
		SJG:		[9096,-3223.98388671875,-155990.34375,6044.24755859375],
		COF:		[9795,-41920.4140625,-192179.4375,175.16964721679688],
		COF_ARENA:	[9095,-20000.5390625,-192163.15625,7153.16650390625],
		COF_OLD:	[9095,-41920.4140625,-192179.4375,175.16964721679688],
		CA:			[9830,22431.369140625,-130349.8671875,12252.3779296875],

        ACE_AKASHA: [9031,72382.5703125,133427.859375,-511.25201416015625],
        ACE_BARACO: [9032,28213.761,178549.875,-1675.327],
        ACE_KRAKAT: [9033,-99937.953125,173327.75,710.5784301757812],

        DSL:  		[9885,14404.6845703125,-130651.453125,-9328.404296875],
        DSU:  		[9886,5847.5751953125,-130631.125,-8977.1845703125],

		HH:			[9950,-7734.88037109375,-84566.2734375,5.249996185302734],
		P3:			[9950,-7448.4482421875,-77912.9296875,6.833255767822266],
		P4:			[9950,-8972.5869140625,-82649.25,3.8399736881256104,9950],
		//P4:		[9950,-7949.337890625,-80699.65625,0.25],

		CR:			[9089,66090.5625,38732.40625,-9112.744140625],
		AC:			[9026,-38.09975051879883,95289.1171875,-10855.5966796875],
        KC:			[9860,-132798.78125,54445.91015625,3262.62646484375],
        
        VOK:		[9029,-7320.2666015625,8386.40625,-1653.4449462890625],
        VOK2:       [9029,-8764.1005859375,17319.35546875,-353.85546875],

        FOK:		[9024,8400.767578125,4999.83837890625,-1671.662841796875],
        FOKSKIP:            [9024,7622.5390625,13914.91015625,-1214.749755859375],

		KNNM:		[9075,62633.7734375,149112.90625,-9474.7685546875],
		KNHM:		[9775,62633.7734375,149112.90625,-9474.7685546875],
		KNXX:		[9975,55619.5078125,142699.5,-10239.08984375],
		KN_JAP: 	[9804,71746.1171875,142332.921875,-10274.6083984375],
		ETHM:		[9773,69073.3828125,84442.7890625,5010.28466796875],
        LOTHM:		[9776,70988.1328125,155620.28125,3477.296630859375],
        NAGAS:           [7031,28857.8671875,-19173.33203125,2547.202880859375],
    }

    const MISC = {
        WOODLAND_PATH:      [9090,99287.2734375,-17482.90625,2176.625244140625],
        MUHRAK_WORKSHOP:    [9011,82779.9140625,-5584.08251953125,478.25396728515625],
        IOD_CLIFFTOP:       [9016,-40866.8984375,-55417.51953125,-5894.52392578125],
	 	IOD_COAST:			[9015,6616.49560546875,-56092.30859375,37.75],
		KAIA_BATTLE:		[9014,24472,-8594,666],
		ARGON_CATACOMBS:	[9018,34028.375,56556.19921875,-179.80624389648438],
		HIDDEN_TUNNEL:		[9021,68185.171875,-85160.2421875,-1529.0419921875],
		ALTAR_OF_VADOMA:	[9091,68502.0078125,99924.8671875,532.1897583007812],
		MEJDANAR_ARENA:		[9077,36028.2265625,-197828.453125,3942.48046875],
		DS_ARENA:			[9083,28282.150390625,-146016.46875,-9327.578125],
    }

    let CURRENT_POS = {};
    let lastTime = (new Date()).getTime();
    let lastMoveTime = 0;

    dispatch.command.add('dg', name => {
        if (!name)
            return;
        if(name.toUpperCase() in DUNGEONS) {
            requestTeleport(DUNGEONS[name.toUpperCase()]);
        } else if (name.toUpperCase() in MISC) {
            requestTeleport(MISC[name.toUpperCase()]);
        } else {
            printHelp();
        }
    })

    dispatch.command.add('tp', name => {
        if(name.toUpperCase() in DUNGEONS) {
            requestInstanceTp(DUNGEONS[name.toUpperCase()]);
        } else if (name.toUpperCase() in MISC) {
            requestInstanceTp(MISC[name.toUpperCase()]);
        } else {
            printHelp();
        }
    })

    dispatch.command.add('getpos', (name) => {
        dispatch.command.message(name + '\t\t [' + CURRENT_POS.zone + ',' + CURRENT_POS.x + ',' + CURRENT_POS.y + ',' + CURRENT_POS.z + '],');
        console.log(name + ':\t\t [' + CURRENT_POS.zone + ',' + CURRENT_POS.x + ',' + CURRENT_POS.y + ',' + CURRENT_POS.z + '],');
    });

    dispatch.hook('C_PLAYER_LOCATION', 1, event => {
        CURRENT_POS.x = event.x1;
        CURRENT_POS.y = event.y1;
        CURRENT_POS.z = event.z1;
        lastTime = (new Date()).getTime();
        lastMoveTime = event.time;
    });

    dispatch.hook('S_LOAD_TOPO', 2, event => {
        CURRENT_POS.zone = event.zone;
    });

    function requestTeleport(dungeon) {
        dispatch.toServer('C_REQUEST_TELEPORT', 1, {
            zone: dungeon[0],
            x: dungeon[1],
            y: dungeon[2],
            z: dungeon[3]
        });
    }

    function requestInstanceTp(dungeon) {
        let place = {
            x: dungeon[1],
            y: dungeon[2],
            z: dungeon[3] + 20
        }

        let timeOffset = (new Date()).getTime() - lastTime;

        dispatch.toClient('S_INSTANT_MOVE', 3, {
            gameId: dispatch.game.me.gameId,
            loc: place,
            w: 0
        });
    }

    function message(msg) {
        dispatch.toClient('S_CHAT', 1, {
            channel: 24,
            unk: 0,
            gm: 0,
            unk1: 0,
            author: '',
            message: '(proxy) ' + msg
        });
    }

    function printHelp() {
        message(`Error: malformed command | !nostalgia <dungeon> | !nostalgia <misc>`);
        message('List of available dungeons: ' + Object.keys(DUNGEONS));
        message('List of available misc instances: ' + Object.keys(MISC));
    }
}
